
{% extends 'header_footer.html' %}


{% load static %}

{% block page_content %}

<style media="screen">

.tags {
  list-style: none;
  margin: 0;
  overflow: hidden;
  padding: 0;
}

.tags li {
  float: left;
}

.tag {
  background: #eee;
  border-radius: 3px 0 0 3px;
  color: #333;
  display: inline-block;
  height: 26px;
  line-height: 26px;
  padding: 0 20px 0 23px;
  position: relative;
  margin: 0 10px 10px 0;
  text-decoration: none;
  -webkit-transition: color 0.2s;
}

.tag::before {
  background: #fff;
  border-radius: 10px;
  box-shadow: inset 0 1px rgba(0, 0, 0, 0.25);
  content: '';
  height: 6px;
  left: 10px;
  position: absolute;
  width: 6px;
  top: 10px;
}

.tag::after {
  background: #fff;
  border-bottom: 13px solid transparent;
  border-left: 10px solid #eee;
  border-top: 13px solid transparent;
  content: '';
  position: absolute;
  right: 0;
  top: 0;
}

.tag:hover {
  background-color: crimson;
  color: white;
}

.tag:hover::after {
   border-left-color: crimson;
}
</style>        

<div class="body_container">
  <div class="view_exercise">
    <div class = "view_exercise_detial">

    <!--  -->
       <div class="container" id="tabs">
           <ul class="nav nav-tabs">
           <li class="active"><a data-toggle="tab" id="video0" href="#menu0">Video 1</a></li>
           </ul>
	           <div class="tab-content">
            <div id="menu0" class="tab-pane active">
             </div>

            <div id="menu1" class="tab-pane fade">
             </div>

            <div id="menu2" class="tab-pane fade">
             </div>

           <div id="menu3" class="tab-pane fade">

             </div>

            <div id="menu4" class="tab-pane fade">
             </div>
          </div>

  </div>
  <div class="position_wrapper">
    <div class="video_container" >
      <div id = "vid_annotations_details" class="vid_annotations_details">

      </div>

      <div class="vid_box" onresize="resizeVid()">
        <video id = "vid_preview" controls>
            <source src="" type="video/mp4">
        </video>
      </div>

    </div>
  </div>



  <div class= "view_exercise_detial_description" class="col-lg-6">
      <div class="form-group">
        <h2 id="detail_title">{{instance.exerciseName}}</h2>
      </br><span> {% for tag in instance.exerciseTag.all %} <a class="tag" href="/viewProfile/?q={{tag.tagDescription}}">{{tag.tagDescription}}</a>{%endfor%}</span>
        </br></br>
        <span> {{instance.exerciseDescription}}</span>

      </div>
  </div>


</div>

  <div class="view_exercise_crossRef">
    <h3>Related Videos</h3>
    <div class="refs_wrapper">
      {% for obj in RelatedExercises %}
        <div class="ref_element">
        {% for video in obj.exerciseVideos.all|slice:":1"%}
          <div class="ref_vid">
            <a href="{%url 'detail' id=obj.exerciseId %}">
              <video>
                <source src="{{video.videoFile.url}}" type="video/mp4" >
               </video>
            </a>
           </div>

        {%endfor%}
          <div class="ref_info">

             <span><strong>
               <a href="/{{obj.exerciseId}}">{{obj.exerciseName |truncatechars:10}}

            </a>
             </strong></span><br/>
             <p>Description:

            {{obj.exerciseDescription |truncatechars:70}}
            </p>
          </div>
      	</div>
      {%endfor%}
    </div>
</div>
<style media="screen">

  .lead {
    font-size: 26px;
    font-weight: 300;
    line-height: 1.4;
}

  label {
      display: inline-block;
      max-width: 100%;
      margin-bottom: 5px;
      font-weight: 700;
      visibility: hidden;
  }

  .btn-default {
    color: #e8e8e8;;
    background-color: #111213;
    border-color: #333;
    margin-top: 5px;
    float: right;
    background-image: linear-gradient(to bottom,#333 0,#333 100%);
    text-shadow:0 0px 0 #fff;
    border-radius:25px;
    /*border-top-right-radius: 25px;
    border-bottom-right-radius: 25px;*/
    background-repeat:repeat-y;
}

blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 17.5px;
    border-left: 5px solid #333;
    margin-top: 35px;
}
textarea.form-control {
  border-radius:25px;
  height: 102px;

}

h5:hover{

color:#333;
/*font-size: 18px*/
}

h5 {
    font-size: 14px;
    color: #777;
}
</style>


<div class="view_exercise_comments">
  <p class="lead text-center">Comments</p>
  <form method="post" class="">{% csrf_token %}
    {{comment_form}}
    {% if user.is_authenticated  %}
      <button id = "submitComment" type="submit" class="btn btn-default" style="display:none">Comment</button>
    {% else %}
      <a  class="btn btn-default signIn_popup_trigger">Sign In</a>
    {% endif  %}
  </form>

  {% for comment in instance.comment_set.all%}
    {% if comment.isParent %}
      <div class="">
        <blockquote>
          <p>{{comment.CommentContent}}</p>
          <footer>by {{comment.CommentPoster}}| {{comment.CommentTimestamp|timesince}} ago</footer>
            {% for child_comment in comment.children %}
              <blockquote>
                <p>{{child_comment.CommentContent}}</p>
                <footer>by {{child_comment.CommentPoster}}| {{child_comment.CommentTimestamp|timesince}} ago</footer>
              </blockquote>
            {% endfor %}
              <div id="{{comment.CommentId}}" style="display:none">
                <form method="post">{% csrf_token %}
                  {{comment_form}}
                  <input type="hidden" name="parent_id" value="{{comment.CommentId}}">
                  <button id = "reply" type="submit" class="btn btn-default ">Share</button>
                </form>
              </div>
              {% if user.is_authenticated  %}
                <h5 id="reply_click" onclick="hideFunction({{comment.CommentId}});">Reply</h5>
              {% else %}
                <h5 class="signIn_popup_trigger">Sign In</h5>
              {% endif  %}
        </blockquote>
      </div>
    {%endif%}
  {% endfor %}
</div>

</div>
</div>
<script type="text/javascript" src="{% static 'js/jquery.js' %}"></script>
<script type="text/javascript">
   var tempvideos = {{ videos|safe}};
   console.log(tempvideos);
   var activeTab = 'video0';
   var viewer;
   var current_vid = 0;

   var tempData = tempvideos[0]["annotations"];
   var myData = [];
   if (tempData != ""){
      myData = JSON.parse(tempData)
    };
   // console.log(myData);
   $(document).ready(function () {
    
    if (tempvideos.length >1){
      console.log('in for loop');
      for(i = 1; i < tempvideos.length; i++){
        var newEle = "<li><a data-toggle=\"tab\" id=\"video"+ i + "\" href=\"#menu"+i+"\">Video "+ (i+1) + "</a></li>";
        $("#tabs .nav-tabs").append(newEle);
      }
     }




      // on click function on each video tab
     $('#tabs .nav-tabs a').on('click', function(){
       activeTab=$(this).attr('id');

        if (activeTab == 'video0'){
          tempData = tempvideos[0]["annotations"];
          if (tempData != ""){
            myData = JSON.parse(tempData)
          };
          current_vid = 0;
        }
        else if (activeTab == 'video1'){
          tempData = tempvideos[1]["annotations"];
          if (tempData != ""){
            myData = JSON.parse(tempData)
          };
     	    current_vid = 1;
        }
        else if (activeTab == 'video2')
        {
          tempData = tempvideos[2]["annotations"];
          if (tempData != ""){
            myData = JSON.parse(tempData)
          };
          current_vid = 2;
        }
        else if (activeTab == 'video3')
        {
          tempData = tempvideos[3]["annotations"];
          if (tempData != ""){
            myData = JSON.parse(tempData)
          };
          current_vid = 3;
        }
        else if (activeTab == 'video4')
        {
    	   tempData = tempvideos[4]["annotations"];
          if (tempData != ""){
            myData = JSON.parse(tempData)
          };
         current_vid = 4;
        }
     	  setVideoSrc();
      });

    });

   
   // function to set video src when change from different videos
  function setVideoSrc() {

    var videoSrc = document.querySelector("video > source");
    var video = document.querySelector("video");

    videoSrc.src = tempvideos[current_vid]['url'];
    video.load();
  };



  function showDetials(element){
    // assign booking content to a variable
    console.log('clicked');
    $content = $(element).closest(".single_tag").find('.tag_description');

    // if content is hiddent, show up arrow. If not show down arrwo
    if($content.css("display")=="none"){
      $(element).css("transform","rotateX(180deg)");
    }
    else{
      $(element).css("transform","rotateX(0deg)");
    }
    // toggle the content on click
    $content.slideToggle(500)


  };
  // resize video when window size changes
  window.onresize = function(event) {
      console.log('get called resize')
      var div = $('#vid_preview');
      var height = div.width() * 0.6;

      div.css('height', height);
  };


 window.onload = function() {
    $(function() {
        var div = $('#vid_preview');
        var height = div.width() * 0.6;

        div.css('height', height);
    });


    var videoSrc = document.querySelector("video > source"),
	       activeTab = 'video0',
         current_vid = 0,
        video = document.getElementById("vid_preview");

    // set video url
    // reference: https://stackoverflow.com/questions/3732562/can-i-use-javascript-to-dynamically-change-a-videos-source
    videoSrc.src = tempvideos[current_vid]['url'];
    video.load();
    setVideoSrc();

    // update annotation layer on video 
    $('#vid_preview').on('timeupdate',function(event){
      if (tempData != ""){
        var dataLength = myData.length;
        var currentT = this.currentTime;
        var innerContent = "";


        for(var i=0;i<dataLength;i++){

            if(currentT > myData[i]["time"] && currentT < (myData[i]["time"]+3)){


              tempX =  myData[i]["x"] * this.getBoundingClientRect().width;
              tempY = myData[i]["y"] * this.getBoundingClientRect().height;
              innerContent += "<p class=\"single_annotation\" style=\"position:absolute; left:"+ tempX + "px; top: " + tempY + "px;\">" + myData[i]["details"] + "</p>" + "\n";

            };
        };

        var infoDiv = document.getElementById("vid_annotations_details");
        infoDiv.innerHTML = innerContent;
      };

    });

}
</script>
 {% endblock %}
