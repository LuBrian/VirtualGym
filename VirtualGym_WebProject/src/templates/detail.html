
{% extends 'header_footer.html' %}


{% load static %}

{% block page_content %}

<div class="body_container">
<div class="container">
  <div class="exercise_form view_exercise_detial">
    <h3 style="text-align: center">{{instance.exerciseName}}</h3>
       <div class="container" id="tabs">
           <ul class="nav nav-tabs">
           <li class="active"><a data-toggle="tab" id="video0" href="#menu0">Video 1</a></li>
           <li><a data-toggle="tab" id="video1" href="#menu1">Video 2</a></li>
           <li><a data-toggle="tab" id="video2" href="#menu2">Video 3</a></li>
           <li><a data-toggle="tab" id="video3" href="#menu3">Video 4</a></li>
           <li><a data-toggle="tab" id="video4" href="#menu4">Video 5</a></li>
           </ul>
	           <div class="tab-content">
            <div id="menu0" class="tab-pane active">
             </div>
             
            <div id="menu1" class="tab-pane fade">
             </div>
             
            <div id="menu2" class="tab-pane fade">
             </div>
             
           <div id="menu3" class="tab-pane fade">

             </div>
             
            <div id="menu4" class="tab-pane fade">
             </div>
          </div>

  </div>
  <div class="position_wrapper">
    <div class="video_container">
      <div id = "vid_annotations_details" class="vid_annotations_details">
        
      </div>

      <div class="vid_box">
        <video id = "vid_preview" width="400px" height="200px" controls>
            <source src="" type="video/mp4">
        </video>
   
      </div>
   
    </div>
  </div>

  <div  class="annotation_tag_wrapper">
    <div id = "annotation_tags" class="annotation_tags">
    </div>
  </div>

  <div class= "view_exercise_detial_description" class="col-lg-6" style="float: right;">
      <div class="form-group">
        <label for="description">Description:</label></br>
        <p style="text-align: left">{{instance.exerciseDescription}}</p>
      </div>
  </div>

  <div class ="exercise_detial_tags">
   <p class="text-left"> &emsp; &emsp;Tags: {% for tag in instance.exerciseTag.all %}
    <a href="http://localhost:8000/viewProfile/?q={{tag.tagDescription}}">{{tag.tagDescription}}</a>
    {%endfor%}</p>
  </div>

<div class="col-lg-12">
  {%if instance.exerciseApproved %}
  <h3>Cross referance:</h3>
    {%for crossExercise in quearyset%}
      {%if instance.exerciseId != crossExercise.exerciseId %}
      <div class="col-lg-12">
        <h3><a href="{%url "detail" id=crossExercise.exerciseId %}">{{crossExercise.exerciseName}}</a></h3>
        <p>{{crossExercise.exerciseDescription}}</p>
      </div>
      {%endif%}

    {%endfor%}
  </br>  </br>
  
    {% for obj in RelatedExercises %}
     </br>
    <a href="http://localhost:8000/{{obj.exerciseId}}">{{obj.exerciseName}}
    </a><br>
    {{obj.exerciseDescription}}

    	{% for video in obj.exerciseVideos.all|slice:":1"%}
      <div style="text-align: right">
	<video width="100" height="100" controls>
      		<source src="{{video.videoFile.url}}" type="video/mp4">
    	</video>
    </div>

	{%endfor%}

    {%endfor%}

</br>
</br>

<div class="">
  <p class="lead text-center">Comment here</p>
  {% if user.is_authenticated  %}
  <form method="post">{% csrf_token %}
    {{comment_form}}
    <button id = "submitComment" type="submit" class="btn btn-default ">Comment</button>
  </form>
  {% else %}
    <div class="create_exercise_perm">
      <p>You have to Login for your comment, <a href="{% url 'signIn' %}">Sign In</a> here</p>
    </div>
  {% endif  %}

  {% for comment in instance.comment_set.all%}
  {% if comment.isParent %}
  <div class="container">
    <blockquote>
      <p>{{comment.CommentContent}}</p>
      <footer>by {{comment.CommentPoster}} at {{comment.CommentTimestamp}}</footer>
      {% for child_comment in comment.children %}
        <blockquote>
          <p>{{child_comment.CommentContent}}</p>
          <footer>by {{child_comment.CommentPoster}} at {{child_comment.CommentTimestamp}}</footer>
        </blockquote>
        {% endfor %}
        {% if user.is_authenticated  %}
        <form method="post">{% csrf_token %}
          {{comment_form}}
          <input type="hidden" name="parent_id" value="{{comment.CommentId}}">
          <button id = "reply" type="submit" class="btn btn-default ">Replay</button>
        </form>
        {% else %}
          <div class="create_exercise_perm">
            <p>You have to Login for your comment, <a href="{% url 'signIn' %}">Sign In</a> here</p>
          </div>
        {% endif  %}

    </blockquote>
  </div>
  {%endif%}
  {% endfor %}
</div>

</div>
</div>
</div>
</div>
</div>
<script type="text/javascript">
   var tempvideos = {{ videos|safe}};
   var activeTab = 'video0';
   var viewer;
   var current_vid = 0;
   var myData = JSON.parse(tempvideos[0]['annotations']);
   $(document).ready(function () {
      // hideEmptyTabs()
     $('#tabs .nav-tabs a').on('click', function(){
       activeTab=$(this).attr('id');
     
        if (activeTab == 'video0'){
          myData = JSON.parse(tempvideos[0]['annotations']);
          current_vid = 0;
        }
        else if (activeTab == 'video1'){
          myData = JSON.parse(tempvideos[1]['annotations']);
     	    current_vid = 1;
        }
        else if (activeTab == 'video2')
        {
          myData = JSON.parse(tempvideos[2]['annotations']);
          current_vid = 2;
        }
        else if (activeTab == 'video3')
        {
          myData = JSON.parse(tempvideos[3]['annotations']);
          current_vid = 3;
        }
        else if (activeTab == 'video4')
        {
    	   myData = JSON.parse(tempvideos[4]['annotations']);
         current_vid = 4;
        }
     	  setVideoSrc();
      });
  	
    });
   	
 //     function hideEmptyTabs() {
 //         if (current_vid == 1)
 //    {
 //        $('#tabs .nav-tabs #video1').hide();
	// $('#tabs .nav-tabs #video2').hide();
	// $('#tabs .nav-tabs #video3').hide();
	// $('#tabs .nav-tabs #video4').hide();
 //    }
 //       else if (current_vid == 2)
 //     {
	// $('#tabs .nav-tabs #video2').hide();
	// $('#tabs .nav-tabs #video3').hide();
	// $('#tabs .nav-tabs #video4').hide();
 //     }
 //     else if (current_vid == 3)
 //    {
	// $('#tabs .nav-tabs #video3').hide();
	// $('#tabs .nav-tabs #video4').hide();
 //    }

 //     else if (current_vid == 4)
 //    {
	// $('#tabs .nav-tabs #video4').hide();
 //    }
 //  }
  function setVideoSrc() {

	var videoSrc = document.querySelector("video > source");
    var video = document.querySelector("video");

    videoSrc.src = tempvideos[current_vid]['url'];
    video.load();

    
    var tempLength = myData.length;
    var tempContent = "";
    for(var i=0;i<tempLength;i++){
      tempContent+= "<div class= \"single_tag\">\n<div class=\"tag_time\">\n<div class=\"tag_info none_border\">\n<p>"+ myData[i]["time"] + "s </p>\n</div>\n</div>\n<div class=\"tag_details svg toggle\" onclick=\"showDetials(this);\">\n</div>\n<div class= \"tag_description\">" + myData[i]["details"] + "\n</div>\n</div>";
    };
    
    var tempDiv = document.getElementById("annotation_tags");
    
    tempDiv.innerHTML = tempContent;
  };



  function showDetials(element){
    // assign booking content to a variable
    console.log('clicked');
    $content = $(element).closest(".single_tag").find('.tag_description');
    
    // if content is hiddent, show up arrow. If not show down arrwo
    if($content.css("display")=="none"){
      $(element).css("transform","rotateX(180deg)");
    } 
    else{
      $(element).css("transform","rotateX(0deg)");
    }
    // toggle the content on click
    $content.slideToggle(500)

    
  };

 window.onload = function() {
    
    // var video = document.querySelector("video"),
        videoSrc = document.querySelector("video > source"),
	       activeTab = 'video0',
         current_vid = 0,
        video = document.getElementById("vid_preview"),

    // set video url
    // reference: https://stackoverflow.com/questions/3732562/can-i-use-javascript-to-dynamically-change-a-videos-source
    videoSrc.src = tempvideos[current_vid]['url'];
    video.load();
    setVideoSrc();
    // hideEmptyTabs();
    console.log(video.videoHeight)

    $('#vid_preview').on('timeupdate',function(event){
      var dataLength = myData.length;
      var currentT = this.currentTime;
      var innerContent = "";
      console.log(this.width);
      for(var i=0;i<dataLength;i++){
          
          if(currentT > myData[i]["time"] && currentT < (myData[i]["time"]+3)){

            tempX =  myData[i]["x"] * this.width;
            tempY = myData[i]["y"] * this.height;
            innerContent += "<p class=\"single_annotation\" style=\"position:absolute; left:"+ tempX + "px; top: " + tempY + "px;\">" + myData[i]["details"] + "</p>" + "\n";


           
          };
      };
     
      var infoDiv = document.getElementById("vid_annotations_details");
      infoDiv.innerHTML = innerContent;
    });
 
}

</script>
 {% endblock %}
